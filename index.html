<script type="module">
    // --- 1. IMPORT FIREBASE (JANGAN DIUBAH) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- 2. KONFIGURASI FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDCnCs-qlRPdk3YUX8qptsEssnzaPkvOlo",
        authDomain: "ourlovejourney-4096d.firebaseapp.com",
        projectId: "ourlovejourney-4096d",
        storageBucket: "ourlovejourney-4096d.appspot.com",
        messagingSenderId: "415202896980",
        appId: "1:415202896980:web:8aa74a553f0bc7111091c1",
        measurementId: "G-J8JMJ3J9W4"
    };

    // Inisialisasi App
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Definisi Koleksi
    const wishlistCol = collection(db, "wishlist");
    const notesCol = collection(db, "notes");
    const activityCol = collection(db, "activities");
    const chatCol = collection(db, "chat");

    const cloudName = "drduqvdxo";
    const uploadPreset = "l1tm7wdn";

    // --- 3. FUNGSI GLOBAL (WAJIB DITEMPEL KE WINDOW AGAR HTML BISA BACA) ---
    
    // Fungsi Switch Tab (Perbaikan Utama)
    window.switchTab = function(tabName, el) {
        // Sembunyikan semua tab
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        // Matikan semua tombol dock
        document.querySelectorAll('.dock-item').forEach(n => n.classList.remove('active'));
        
        // Aktifkan tab yang dipilih
        const targetTab = document.getElementById('tab-' + tabName);
        if (targetTab) targetTab.classList.add('active');
        
        // Aktifkan tombol dock yang diklik
        if (el) el.classList.add('active');
        
        // Khusus tab chat, cek nama
        if (tabName === 'chat') {
            checkChatIdentity();
        }
    };

    // Fungsi Identitas Chat
    window.checkChatIdentity = function() {
        let savedName = localStorage.getItem("chat_username");
        if (!savedName) {
            setTimeout(() => {
                let name = prompt("Masukkan nama panggilan kamu:", "Sayang");
                if (name) {
                    localStorage.setItem("chat_username", name);
                    alert("Halo " + name + "! Chat siap.");
                    location.reload(); // Refresh agar variabel myName terupdate
                }
            }, 500);
        }
    };

    // Fungsi Lightbox
    window.openLightbox = function(url) {
        const lb = document.getElementById('lightbox');
        const img = document.getElementById('lightbox-img');
        if(lb && img) {
            img.src = url;
            lb.style.display = 'flex';
            setTimeout(() => lb.classList.add('show'), 10);
        }
    };
    
    window.closeLightbox = function() {
        const lb = document.getElementById('lightbox');
        if(lb) {
            lb.classList.remove('show');
            setTimeout(() => { lb.style.display = 'none'; }, 300);
        }
    };

    // Fungsi Upload
    window.uploadPhoto = async function(file, id, colName) {
        if (!file) return;
        const loader = document.getElementById(`loader-${id}`);
        if(loader) loader.style.display = 'block';
        
        const formData = new FormData(); 
        formData.append('file', file); 
        formData.append('upload_preset', uploadPreset);
        
        try {
            const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, { method: 'POST', body: formData });
            const result = await response.json();
            if (result.secure_url) await updateDoc(doc(db, colName, id), { photo: result.secure_url });
        } catch (e) { 
            alert("Gagal upload: " + e.message); 
        } finally { 
            if(loader) loader.style.display = 'none'; 
        }
    };

    // Fungsi Mark Done & Delete
    window.markDone = async function(id, status) {
        if (!status) {
            const sound = document.getElementById('success-sound');
            if(sound) { sound.currentTime = 0; sound.play().catch(e=>{}); }
            if(window.confetti) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#ff85a1', '#fbb1bd', '#ff477e'] });
        }
        const t = new Date();
        const dateStr = `${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()}`;
        await updateDoc(doc(db, "wishlist", id), { completed: !status, date: !status ? dateStr : null });
    };

    window.deleteItem = async function(id, colName = "wishlist") { 
        if(confirm("Hapus item ini?")) await deleteDoc(doc(db, colName, id)); 
    };
    
    window.deleteNote = async function(id) {
        if(confirm("Lepas catatan ini?")) await deleteDoc(doc(db, "notes", id));
    };


    // --- 4. LOGIKA APLIKASI UTAMA ---

    // Music Player
    const musicBtn = document.getElementById('music-control');
    const audio = document.getElementById('bg-music');
    let isPlaying = false;

    if(musicBtn && audio) {
        musicBtn.onclick = () => {
            if (isPlaying) { 
                audio.pause(); 
                musicBtn.classList.remove('playing'); 
            } else { 
                audio.play().then(() => { 
                    musicBtn.classList.add('playing'); 
                }).catch(e => console.log("Perlu interaksi user dulu"));
            }
            isPlaying = !isPlaying;
        };
    }

    // Dock Animation
    const dock = document.getElementById('main-dock');
    const items = document.querySelectorAll('.dock-item');
    if(dock) {
        dock.addEventListener('mousemove', (e) => {
            items.forEach(item => {
                const rect = item.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const dist = Math.abs(e.clientX - centerX);
                const scale = Math.max(50, 75 - (dist * 0.3)); 
                if(dist < 100) { 
                    item.style.width = `${scale}px`; 
                    item.style.height = `${scale}px`; 
                    item.style.fontSize = `${1.5 * (scale/50)}rem`; 
                } else { 
                    item.style.width = '50px'; 
                    item.style.height = '50px'; 
                    item.style.fontSize = '1.5rem'; 
                }
            });
        });
        dock.addEventListener('mouseleave', () => {
            items.forEach(item => { 
                item.style.width = '50px'; 
                item.style.height = '50px'; 
                item.style.fontSize = '1.5rem'; 
            });
        });
    }

    // Hitung Hari
    const startDate = new Date(2025, 2, 9); // 9 Maret 2025
    const now = new Date();
    const diffInDays = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
    const elDays = document.getElementById('days-counter');
    if(elDays) elDays.innerText = diffInDays + " Hari";
    
    let nextAnniv = new Date(now.getFullYear(), startDate.getMonth(), startDate.getDate());
    if (now > nextAnniv) nextAnniv.setFullYear(now.getFullYear() + 1);
    const elNext = document.getElementById('next-anniv-counter');
    if(elNext) elNext.innerText = Math.ceil((nextAnniv - now) / (1000 * 60 * 60 * 24)) + " Hari Lagi";


    // --- 5. LOGIKA DATABASE (SNAPSHOTS) ---

    // WISHLIST
    const wishListUI = document.getElementById('wish-list');
    const memoriesUI = document.getElementById('memories-list');
    
    onSnapshot(query(wishlistCol, orderBy("createdAt", "desc")), (snapshot) => {
        if(wishListUI) wishListUI.innerHTML = ''; 
        if(memoriesUI) memoriesUI.innerHTML = '';
        
        snapshot.forEach((doc) => {
            const data = { id: doc.id, ...doc.data() };
            // Render Wishlist Item
            if(wishListUI) {
                const li = document.createElement('li');
                if (data.completed) li.classList.add('completed');
                const tgl = data.date ? `âœ… Selesai: ${data.date}` : '';
                
                li.innerHTML = `
                    <div class="wish-content">
                        <span class="wish-text">${data.text}</span>
                        <span class="date-info">${tgl}</span>
                        ${data.photo ? `<img src="${data.photo}" class="photo-preview" onclick="openLightbox('${data.photo}')">` : ''}
                        <div id="loader-${data.id}" class="loading-text">Loading...</div>
                    </div>
                    <div class="actions">
                        <input type="file" id="file-${data.id}" style="display:none" accept="image/*" onchange="window.uploadPhoto(this.files[0], '${data.id}', 'wishlist')">
                        <button class="btn-photo" onclick="document.getElementById('file-${data.id}').click()">ðŸ“·</button>
                        <button class="btn-done" onclick="window.markDone('${data.id}', ${data.completed})">âœ”</button>
                        <button class="btn-delete" onclick="window.deleteItem('${data.id}', 'wishlist')">âœ–</button>
                    </div>
                `;
                wishListUI.appendChild(li);
            }
            
            // Render Memory
            if(data.completed && data.photo && memoriesUI) {
                const div = document.createElement('div');
                div.className = 'memory-card';
                div.innerHTML = `<img src="${data.photo}" class="memory-img" onclick="openLightbox('${data.photo}')"><div class="memory-info"><span class="memory-title">${data.text}</span><span class="memory-date">${data.date || ''}</span></div>`;
                memoriesUI.appendChild(div);
            }
        });
    });

    // ACTIVITIES
    const activityUI = document.getElementById('activity-list');
    onSnapshot(query(activityCol, orderBy("createdAt", "desc")), (snapshot) => {
        if(activityUI) activityUI.innerHTML = '';
        snapshot.forEach((doc) => {
            const data = { id: doc.id, ...doc.data() };
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="wish-content">
                    <span class="wish-text">${data.text}</span>
                    ${data.photo ? `<img src="${data.photo}" class="photo-preview" onclick="openLightbox('${data.photo}')">` : ''}
                    <div id="loader-${data.id}" class="loading-text">Loading...</div>
                </div>
                <div class="actions">
                    <input type="file" id="file-${data.id}" style="display:none" accept="image/*" onchange="window.uploadPhoto(this.files[0], '${data.id}', 'activities')">
                    <button class="btn-photo" onclick="document.getElementById('file-${data.id}').click()">ðŸ“·</button>
                    <button class="btn-delete" onclick="window.deleteItem('${data.id}', 'activities')">âœ–</button>
                </div>
            `;
            activityUI.appendChild(li);
        });
    });

    // NOTES
    const notesUI = document.getElementById('notes-list');
    onSnapshot(query(notesCol, orderBy("createdAt", "desc")), (snapshot) => {
        if(notesUI) notesUI.innerHTML = '';
        snapshot.forEach((doc) => {
            const data = { id: doc.id, ...doc.data() };
            const div = document.createElement('div');
            div.className = 'note-card';
            div.innerHTML = `<div class="pin"></div>${data.text}<div class="delete-note" onclick="window.deleteNote('${data.id}')">âœ–</div>`;
            notesUI.appendChild(div);
        });
    });

    // CHAT (REALTIME)
    const chatBox = document.getElementById('chat-box');
    const myName = localStorage.getItem("chat_username"); // Ambil nama dari penyimpanan

    // Gunakan try-catch agar jika chat error, web tetap jalan
    try {
        if(chatBox) {
            // Gunakan 'limit(50)' jika database sudah di-index, jika belum, hapus limitnya
            const q = query(chatCol, orderBy("createdAt", "asc")); 
            
            onSnapshot(q, (snapshot) => {
                chatBox.innerHTML = '';
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const div = document.createElement('div');
                    const isMe = msg.sender === myName;
                    div.className = `chat-bubble ${isMe ? 'sent' : 'received'}`;
                    const time = new Date(msg.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    div.innerHTML = `<span class="chat-name">${msg.sender}</span>${msg.text}<span class="chat-time">${time}</span>`;
                    chatBox.appendChild(div);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }
    } catch (e) {
        console.log("Chat error (mungkin permission):", e);
    }


    // --- 6. EVENT LISTENER TOMBOL TAMBAH ---
    
    // Tambah Wishlist
    document.getElementById('add-btn').onclick = async () => {
        const input = document.getElementById('wish-input');
        if (input.value === '') return;
        await addDoc(wishlistCol, { text: input.value, completed: false, date: null, photo: null, createdAt: Date.now() });
        input.value = '';
    };

    // Tambah Activity
    document.getElementById('add-activity-btn').onclick = async () => {
        const input = document.getElementById('activity-input');
        if (input.value === '') return;
        await addDoc(activityCol, { text: input.value, photo: null, createdAt: Date.now() });
        input.value = '';
    };

    // Tambah Note
    document.getElementById('add-note-btn').onclick = async () => {
        const input = document.getElementById('note-input');
        if (input.value === '') return;
        await addDoc(notesCol, { text: input.value, createdAt: Date.now() });
        input.value = '';
    };

    // Kirim Chat
    const chatInput = document.getElementById('chat-input');
    const sendChatBtn = document.getElementById('send-chat-btn');
    
    if(sendChatBtn) {
        sendChatBtn.onclick = async () => {
            if (chatInput.value.trim() === '') return;
            if (!myName) { window.checkChatIdentity(); return; } // Cek nama
            
            await addDoc(chatCol, { 
                text: chatInput.value, 
                sender: myName, 
                createdAt: Date.now() 
            });
            chatInput.value = '';
        };

        chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendChatBtn.click();
        });
    }

</script>
